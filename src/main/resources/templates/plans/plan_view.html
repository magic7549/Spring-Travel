<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{fragments/layout}">

<!-- css start -->
<th:block layout:fragment="css">
    <link th:href="@{/css/plan.css}" rel="stylesheet" />
</th:block>
<!-- css end -->

<!-- js start -->
<th:block layout:fragment="script">
    <script src="https://code.jquery.com/jquery-3.7.1.js" integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4=" crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.js" integrity="sha256-xLD7nhI62fcsEZK2/v8LsBcb4lG7dgULkuXoXB/j91c=" crossorigin="anonymous"></script>
</th:block>
<!-- js end -->

<!-- content start -->
<div layout:fragment="content" class="container-xxl">
    <div class="plan-detail-top-menu row">
        <div class="col-6 text-start"><a th:href="@{/plans}" class="back-href"><i class="bi bi-arrow-left"></i> 목록으로</a></div>
        <div class="col-6 text-end">
            <button type="button" class="btn btn-primary" onclick="saveDestinations()">저장</button>
            <button type="button" class="btn btn-danger">삭제</button>
        </div>
    </div>
    <div class="plan-detail-header text-center">
        <div class="title" th:text="${planDetail.title}"></div>
        <div class="date"><span th:text="${planDetail.startDate}"></span> ~ <span th:text="${planDetail.endDate}"></span></div>
    </div>
    <div class="plan-detail-content row">
        <!-- 목적지 목록 -->
        <div class="col-4">
            <div class="accordion destination-accordion" id="accordionExample">
                <!-- travelDuration만큼 반복할 아이템 -->
                <div th:each="day, dayIdx : ${#numbers.sequence(1, planDetail.travelDuration)}" class="accordion-item">
                    <h2 class="accordion-header">
                        <button th:id="'accordion-button-' + ${dayIdx.index}" class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                th:data-bs-target="'#collapse' + ${dayIdx.index}">
                            Day [[${day}]]
                        </button>
                    </h2>
                    <div th:id="'collapse' + ${dayIdx.index}" class="accordion-collapse collapse"
                         data-bs-parent="#accordionExample">
                        <div class="accordion-body destination-accordion-body">
                            <!-- n 일차 동안(같은 visitDate 동안) 방문할 관광지 목록 -->
                            <th:block th:each="destination : ${planDetail.destinations}"
                                 th:if="${destination.visitDate == day}">
                                <div class="destination-card">
                                    <div class="orderNum" th:text="${destination.orderNum}"></div>
                                    <div class="title" th:text="${destination.title}"></div>
                                    <div class="addr">
                                        <span class="addr1" th:text="${destination.addr1}"></span>
                                        <span class="addr2" th:text="${destination.addr2}"></span>
                                    </div>
                                </div>
                            </th:block>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- 우측 지도 및 관광지 목록 -->
        <div class="col-8">
            <div class="ratio ratio-1x1 map-container">
                <div id="map"></div>
            </div>
            <div class="place-list">
                <div class="search-container">
                    <div class="select-area" style="margin-bottom: 10px; width: 150px; text-align-last: center; text-align: center;">
                        <select class="form-control" id="areaSelect"></select>
                    </div>
                    <div class="row g-3 align-items-center">
                        <div class="col">
                            <input type="text" class="form-control">
                        </div>
                        <div class="col-auto">
                            <button type="button" class="btn btn-primary">검색</button>
                        </div>
                    </div>
                </div>
                <div class="place-card" style="width: 100%; height: 156px;">
                    s
                </div>
            </div>
        </div>

    </div>
    <script type="text/javascript" th:src="@{//dapi.kakao.com/v2/maps/sdk.js?appkey=} + ${apiKey}"></script>
    <script th:inline="javascript">
        /*<![CDATA[*/
        var destinations =[[${planDetail.destinations}]];
        /*]]>*/
        var currentAccordionId = 1;
        var markers = [];
        var polylines = [];

        // visitDate를 기준으로 그룹화한 결과를 저장할 객체 ex) groupedDestinations[1] => 1일날 방문할 관광지 목록
        var groupedDestinations = {};
        destinations.forEach(function(destination) {
            if (!groupedDestinations[destination.visitDate]) {
                groupedDestinations[destination.visitDate] = [];
            }
            groupedDestinations[destination.visitDate].push(destination);
        });

        var map_container = document.getElementById('map'),
            options = {
                 center: new kakao.maps.LatLng(33.450701, 126.570667),
                 level: 20
            };
        var map = new kakao.maps.Map(map_container, options);

        $(function(){
            $("#collapse0").addClass("show");
            $("#accordion-button-0").removeClass("collapsed");

            $('.accordion-button').click(function(){

                // 현재 아코디언의 ID에서 "accordion-button-"를 제거하고 정수로 변환하여 변수에 저장
                currentAccordionId = parseInt($(this).attr('id').replace('accordion-button-', '')) + 1;
                openMap();
            });

            openMap();
        });

        $(".accordion-body").each(function() {
            $(this).sortable({
                axis: "y",
                start: function(event, ui) {
                    // 드래그 시작 시 호출
                },
                stop: function(event, ui) {
                    // 드래그 종료 시 호출
                    reorder($(this));
                    openMap();
                }
            });
        });

        function reorder(accordionBody) {
            accordionBody.find('.destination-card').each(function(i, box) {
                var orderNumElement = $(box).find('.orderNum');
                var prevNum = parseInt(orderNumElement.text(), 10);
                orderNumElement.text(i + 1);

                groupedDestinations[currentAccordionId][prevNum - 1].orderNum = i + 1;

                // ajax로
            });
            groupedDestinations[currentAccordionId] = groupedDestinations[currentAccordionId].sort(function (a, b) {
                return a.orderNum - b.orderNum;
            });
        }

        function openMap() {
            // 지도 중심 좌표 설정
            map.setCenter(new kakao.maps.LatLng(groupedDestinations[currentAccordionId][0].mapY, groupedDestinations[currentAccordionId][0].mapX));

            // 마커 생성
            markerInit();
            for (var i = 0; i < groupedDestinations[currentAccordionId].length; i ++) {
                var marker = new kakao.maps.Marker({
                    map: map,
                    position: new kakao.maps.LatLng(groupedDestinations[currentAccordionId][i].mapY, groupedDestinations[currentAccordionId][i].mapX)
                });
                markers.push(marker);
            }

            // 선 생성
            var linePath = [];
            for (var i = 0; i < groupedDestinations[currentAccordionId].length; i ++) {
                linePath.push(new kakao.maps.LatLng(groupedDestinations[currentAccordionId][i].mapY, groupedDestinations[currentAccordionId][i].mapX));
            }
            lineInit();
            var polyline = new kakao.maps.Polyline({
                map: map,
                path: linePath,
                strokeWeight: 5,
                strokeColor: '#3549ff',
                strokeOpacity: 0.7,
                strokeStyle: 'solid'
            });
            polylines.push(polyline);
        }

        function markerInit() {
            for (var i = 0; i < markers.length; i++) {
                markers[i].setMap(null);
            }
            markers = [];
        }

        function lineInit() {
            for (var i = 0; i < polylines.length; i++) {
                polylines[i].setMap(null);
            }
            polylines = [];
        }

        function saveDestinations() {
            var mergedDestinations = [];

            // visitDate로 나눠져 있는 목적지를 합치기
            Object.values(groupedDestinations).forEach(function(destinations) {
                mergedDestinations = mergedDestinations.concat(destinations);
            });

            console.log(mergedDestinations);

            /*<![CDATA[*/
            var planIdx = [[${planIdx}]];
            /*]]>*/
            $.ajax({
                type: "PUT",
                contentType: "application/json",
                url: "/api/v1/destinations/" + planIdx,
                data: JSON.stringify(mergedDestinations),
                success: function(response) {
                    // 성공 시 처리
                    console.log(response);
                },
                error: function(error) {
                    // 실패 시 처리
                    console.error(error);
                }
            });
        }

    </script>
    <script th:inline="javascript">
        var areaCode = {
            0: "전국",
            1: "서울",
            2: "인천",
            3: "대전",
            4: "대구",
            5: "광주",
            6: "부산",
            7: "울산",
            8: "세종특별자치시",
            31: "경기도",
            32: "강원특별자치도",
            33: "충청북도",
            34: "충청남도",
            35: "경상북도",
            36: "경상남도",
            37: "전북특별자치도",
            38: "전라남도",
            39: "제주도"
        };

        var areaSelect = document.getElementById("areaSelect");

        for (var code in areaCode) {
            var option = document.createElement("option");
            option.value = code;
            option.text = areaCode[code];
            areaSelect.appendChild(option);
        }
    </script>
</div>
<!-- content end -->

</html>